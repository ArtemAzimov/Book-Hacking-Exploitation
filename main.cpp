#include <iostream>
#include <fstream>
#include <string>
#include <algorithm>

#include "tinyexpr.h"

using std::string, std::cout, std::endl;

// 1, 3, 4, 6 = 24
// 6 / (1 - (3 / 4)) = 24

class MathExprEnum
{
    int     runCounter;
    string  signs;
    string  operators;
    int* intArray;
    unsigned int intArraySize;
    double value;

public:
    MathExprEnum()      // default constructor
    {
        runCounter = 0;
        intArraySize = 4;
        intArray = new int[intArraySize] {1, 3, 4, 6};
        value = 24;
        signs = ("+-");
        operators = ("-*/");
    }
    ~MathExprEnum(){}

    const char* toChar(string str)
    {
        const char* pchar = str.c_str();
        return pchar;
    }

    string toString(int* array)
    {
        string str;
        for (int i = 0; i < intArraySize; i++) 
        {
            str += std::to_string(array[i]);
        }
        return str;
    }

    void DefaultFiller(string str)       // fill all posible for altering positions with '+'
    {
        string source = str;
        unsigned int index = 0;
        int num_of_chars[4] {2, 2, 3, 2};
        int n = 0;

        for (int i : num_of_chars)      
        {
            source.insert(index, num_of_chars[n], '+');
            index += num_of_chars[n] + 1;
            n++;
        }
        SignFiller(source);
    }

    void SignFiller(string& source)      // fill with signs '-' from begin to end
    {
        int num_of_chars2[6] {0, 1, 3, 3, 1, 3};
        int n2 = 0;

        for (int index = 0; index < source.length(); index += num_of_chars2[n2])        
        {
            for (int j = 0; j < signs.length(); j++)
            {
                source[index] = signs[1];
                OperatorFiller(source);
            }
            n2++;
        }
    }

    void OperatorFiller(string& source)      // fill with operators from begin to end
    {
        int num_of_chars3[3] {3, 3, 4};
        int n3 = 0;
        int index = 3;

        for (index; index <= 10; index += num_of_chars3[n3])        
        {
            for (int j = 0; j < operators.length(); j++)
            {
                source[index] = operators[j];
                BracketPlacer(source);
            }
            n3++;
        }
    }

    void BracketPlacer(string& source)
    {
        string case1 = source;
        string case2 = source;
        string case3 = source;
        string case4 = source;
        string case5 = source;

        // case0 x+x+x+x
        EvaluationResult(source);

        // case 1 (x+x)+x+x
        case1.insert(1, 1, '(');
        case1.insert(7, 1, ')');
        EvaluationResult(case1);        

        // case 2 x+(x+x)+x
        case2.insert(4, 1, '(');
        case2.insert(11, 1, ')');
        EvaluationResult(case2);

        // case 3 x+x+(x+x)
        case3.insert(8, 1, '(');
        case3.append(")");
        EvaluationResult(case3);

        // case 4 (x+x)+(x+x)
        case4.insert(1, 1, '(');
        case4.insert(7, 1, ')');
        case4.insert(9, 1, '(');
        case4.append(")");
        EvaluationResult(case4);

        // case 5 6 / (1 - (3 / 4)) = 24                    --4-+1/++6/+3
        case5.insert(4, 1, '(');
        case5.append(")");
        case5.insert(6, 1, '(');
        case5.append(")");
        EvaluationResult(case5);
    }

    void EvaluationResult(string& source)
    {
        bool isFound = false;
        te_parser pars;
        double result = pars.evaluate(toChar(source));
        if (result == value) isFound = true;
        FileWriter(source, result, isFound);
    }

    void ArrayPermutations()        // generates 540 variants for 1 call
    {
        string strArrayPermd;
        string strArray = toString(intArray);
        std::sort(strArray.begin(), strArray.end());
        DefaultFiller(strArray);
        while(std::next_permutation(strArray.begin(), strArray.end()))
        {
            DefaultFiller(strArray);
        }
    }

    void ShowExpression(string& str)
    {
        runCounter++;   
        cout << str << endl;
    }

    void ShowRunCounter()
    {
        cout << ".............Number of variants: " << runCounter << endl;
    }

    void FileWriter(string& str, double& res, bool isFound)
    {
        runCounter++;
        string new_str;
        string resStr = std::to_string(res);
        string option = "";
        if (isFound == true) option = " <------------------- SOLUTION IS FOUND!";
        new_str = "Variant # [" + std::to_string(runCounter) + "]   " + str + "   = " + resStr + option + '\n';


        std::ofstream text_file;
        text_file.open("variants.txt", std::ios_base::app);
        text_file << new_str;
        text_file.close();
    }
};



int main()
{
    MathExprEnum x;
    x.ArrayPermutations();
    // x.ShowRunCounter(); // 12'960 variants      // 15'552
}       